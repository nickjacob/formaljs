(function(t,n){"use strict";function c(e,t){this.instances++,this.module="formal-"+t+"-",this.el=e,this._dom={},this.prefix=this.module+this.instances+this.PREFIX_DELIM,this.processTemplates()}function h(e,r){c.call(this,e,"timeline"),this.ACTIVE_CLASS=this.module+"active";var i=this;if(!e||!r)throw"element and form required";this.form=r,this.elems={},this.current={el:null,name:""},this.elemsArray=[],this.elemIndexes={},this.rendered={};var s=0;S.map(r.elements,function(e,t){e.name=e.name||e.id||e.type;if(e&&!i.elems[e.name]&&e.type!=="submit"){if(e.hasAttribute("hidden")){var n=e;e=e.parentNode,e.setAttribute("name",n.name),e.name=n.name,e.type=n.type}i.elems[e.name]=e,i.elemIndexes[e.name]=s,i.elemsArray[s]=e,s++}else e.type==="submit"&&(i.submitButton=e)}),this.stats={total:i.elemsArray.length,complete:0,completed:!1},t.document.addEventListener("focusin",S.proxy(this.focusListener,this),!1),this.on(p.CHANGE_EVT,this.changeListener),this.on("submit",this.submitListener),this.on("click",this.clickListener),this.on("keyup",function(e){var t=e.which||e.keyCode;t===p.LEFT_KEY?this.prev(e):t===p.RIGHT_KEY?this.next(e):e.ctrlKey&&e.shiftKey&&e===191?this.modal(e):i.rendered[e.target.name]!==n&&(i.rendered[e.target.name].style.width=e.target.offsetWidth+(e.target.value||e.target.getAttribute("value")).length*i.LENGTH_MUL+"px")}),this.render(),this.select(this.rendered[0]),this.elemsArray[0].focus()}function d(e,t){var n=document.createElement("input");n.type="text",n.name=e,n.setAttribute("name",e),n.setAttribute("hidden",!0),n.className=p.HIDDEN_CLASS,n.id=t[0].value;var r=S.map(t,function(e,t){if(e.checked||e.getAttribute("checked"))return e.value});return n.value=r.join(","),t[0].parentNode.appendChild(n),n}function v(){this.wrapped={}}function m(e,t,n,r){this.label=t,this.el=e,S.each(this.el.children,function(e,t){}),this.input=n,this.type=this.input.type,this.name=this.input.name||this.input.getAttribute("name"),S.isPlainObject(r)&&r.validation?this.validation=S.proxy(r.validation,this):this.validation=function(e){return!!e.length},a.defineProperty(this,"_value",{get:function(){return this.input.value},set:function(e){this.input.value=S.isArray(e)?e.join(this.cnst.VALUE_DELIM):e},enumerable:!0,configurable:!0});var i=this;this.el.addEventListener("keyup",function(e){var t=e.which||e.keyCode;if(t!==p.LEFT_KEY&&t!==p.RIGHT_KEY&&t!==p.ENTER_KEY)return;!/radio|checkbox/i.test(i.type)&&!/select/i.test(i.input.tagName)&&i.input.selectionStart!==0&&i.input.selectionStart!==i.input.value.length&&(i.keyEvent.call(i,e,t),e.stopPropagation())},!1),this.el.addEventListener("change",function(e){var t=e.target;t===i.input&&i.fireEvent(p.CHANGE_EVT)},!1)}function g(e,t,n,r){this.valid=e,this.state=t,this.value=n,this.name=r}function y(e){var t=e.getAttribute("type")||e.getAttribute("tag"),n=e.getElementsByTagName("label")[0],r=e.getElementsByTagName("input")[0]||e.getElementsByTagName("textarea")[0]||e.getElementsByTagName("select")[0];m.call(this,e,n,r)}function b(e){var t=this,n=e.hasAttribute("data-selector-type")?e.getAttribute("data-selector-type"):e.type,r=a.slice.call(e.getElementsByTagName("input")),i=a.slice.call(e.getElementsByTagName("label"));e.name=this.name||r[0].name,e.type=this.type||r[0].type,this.input=d(e.name,r),this.el=e,c.call(this,e,"selectable"),m.call(this,e,i[0],this.input);var s=0,o=r.length,u="";for(;s<o;s++)u+=this.templates.item({name:r[s].name,value:r[s].getAttribute("value"),displayValue:a.camelToSentance(r[s].getAttribute("value"))});var f=document.createElement("div");f.className=this.module+"grp btngrp",f.innerHTML=u,f.id=this.prefix+this.name,this.el.appendChild(f),this.el.setAttribute("contenteditable",!0),this.elements={},this.count=0,this.reverseElements={};for(s=0;s<o;s++)this.elements[s]=this.getById(r[s].value),this.elements[s].setAttribute("contenteditable",!1),this.reverseElements[this.elements[s].getAttribute("value")]=s,this.el.removeChild(r[s]);this.count=s-1,this.active=0,this.el.addEventListener("focus",S.proxy(this.onfocus,this)),this.el.addEventListener("click",function(e){var n=t.reverseElements[e.target.getAttribute("value")];t.select.call(t,n)}),this.el.addEventListener("keyup",function(e){var n=e.which||e.keyCode;(n===p.LEFT_KEY||n===p.RIGHT_KEY||n===p.ENTER_KEY)&&t.keyEvent.call(t,e,n)},!1),this.activate(0)}function w(e){e.type="checkbox",this.selection=[],b.call(this,e)}function E(e){e.type="radio",this.selection=[],b.call(this,e)}function x(e){var t=e.getElementsByClassName("formal-field"),n=new v,r=0,i=0,s=t.length,o=null,u=[];if(!t||!s)return;for(;r<s;r++)if(o=n.wrap(t[r]))u[i]=o,i++;return u}function T(e,n){if(this===t)return this.instances[el]||new T(e,n);this.el=document.getElementById(e),this.text=this.el.elements.item(0),this.elements=this.el.elements;var r=0,i=this.elements.length,s;for(;r<i;r++)s=this.elements[r],!/formal\-field/.test(s.parentNode.className)&&s.type!=="submit"&&(s.outerHTML='<div class="formal-field"><label for="'+s.name+'">'+a.camelToSentance(s.name)+"</label>"+s.outerHTML+"</div>");this.wrapped=x(this.el),this.timeline=new h(this.el.parentNode,this.el)}var r=r||"0.0.1";S=t.$||t.jQuery||t.jq_shim;var i={}.hasOwnProperty,s={}.toString,o=[].slice,u=u||{},a=u.util=u.util||{};a.toString=s,a.slice=o,a.hasOwnProperty=i,a.camelToSentance=function(e){if(e)return e.replace(/([A-Z])/g," $1").replace(/^./,function(e){return e.toUpperCase()})},a.keys=function(e){if(!e)return;if(e.prototype.keys)return e.keys();var t=[],n;for(n in e)i.call(e,n)&&t.push(n);return t},a.values=function(e){if(!e)return;if(e.prototype.values)return e.values();var t=[],n;for(n in e)i.call(e)&&t.push(e[n]);return t},a.absolutePosition=function(e){var t=0,n=0;while(e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop))t+=e.offsetLeft-e.scrollLeft,n+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:n}},a.testFormEl=function(e){if(!e)throw"Form element is undefined.";if(s.call(e)!=="[object HTMLFormElement]")throw"Element must be an HTMLFormElement";if(!e.elements||!e.elements.length)throw"Form must contain fields."},a.customEvent=function(e,n){var r;return t.CustomEvent?r=new CustomEvent(e):r=document.createEvent(e),r.initCustomEvent(e,!0,!0,n),r};var f={};a.inherits=function(e,t){return f[t]=f[t]||function(){},f[t].prototype=e.prototype,t.prototype=new f[t],t.prototype.constructor=t,t.prototype.parent=e.prototype,t},a.defineProperty=function(e,t,n){if(Object.defineProperty)return Object.defineProperty(e,t,n);(function(e,t,n){n.get&&n.__defineGetter__&&e.__defineGetter__(t,n.get),n.set&&e.__defineSetter__&&e.__defineSetter__(t,n.set),n.value&&(e[t]=n.value)})(e,t,n)},a.keysListener=function(e,t,n,r){function i(e,t){~S.inArray(n,e)&&r.call(t.target,t,keyCode)}function s(e,t){e===n&&r.call(t.target,t,keyCode)}var o=S.isArray(n)?i:s;e.addEventListener(t,function(e){o(e.which||e.keyCode,e)},!1)},a.find=function(e,t,r){function s(e){if(!e)return;var n=e.children,o=n.length,u=0;if(!n||!n.length)return;for(;u<o;u++)n[u]&&(r&&s(n[u]),t(n[u])&&i.push(n[u]))}r=r===n?!1:r;var i=[];return s(e),i};var l=/\[\[\s*([\w_0-9\$]*)\s*\]\]/ig;a.templ=function(e,t){return t=t||{},function(r){return e.replace(l,function(e,i){return t[i]!==n?t[i]:r[i]!==n?r[i]:""})}},c.prototype={PREFIX_DELIM:"__",instances:0,getElName:function(e){var t=e.split(this.PREFIX_DELIM);return t.length===2?t[1]:null},getEl:function(e){if(e=this.getElName(e))return this.dom(e)},getId:function(e){return this.prefix+e},getById:function(e){return t.document.getElementById(this.getId(e))},append:function(e){var t;if(!e)return;typeof e=="string"?(t=document.createDocumentFragment(),t.innerHTML+=e):t=e,this.el.appendChild(t)},fire:function(e,t){return this.el.dispatchEvent(a.customEvent(e,t))},templ:function(e){return a.templ(e,{prefix:this.prefix,module:this.module})},processTemplates:function(){for(var e in this.templates)typeof this.templates[e]!="function"&&(this.templates[e]=this.templ(this.templates[e]))},dom:function(e){return this._dom[e]!=null?this._dom[e]:this._dom[e]=this.getById(e)},on:function(e,t){this.el.addEventListener(e,S.proxy(t,this),!1)}},a.inherits(c,h),S.extend(h.prototype,{BASE_WIDTH:100,LENGTH_MUL:10,templates:{element:"<li class='[[module]][[type]]' type='[[type]]' name='[[name]]' id='[[prefix]][[name]]'>[[displayName]]</li>",list:"<ul class='[[module]]list' id='[[prefix]]list'>[[inner]]</ul>",container:"<div class='[[module]]timeline' id='[[prefix]]container'><div class='[[module]]timeline-inner' id='[[prefix]]inner'><div class='[[module]]closebtn' id='[[prefix]]closebtn'>hide</div>[[inner]]</div>[[controls]]</div>",controls:"<div class='[[module]]controls id='[[prefix]]controls'><div class='btngrp reset' id='[[prefix]]reset'><a id='[[prefix]]reset'>reset</a></div><div class='btngrp dir' ><a class='prev' id='[[prefix]]prev'></a><a class='next' id='[[prefix]]next'></a></div><div class='[[module]]progressbar' id='[[prefix]]progressbar-outer'><div class='[[module]]progress-inner' id='[[prefix]]progress-inner'></div><span id='[[prefix]]progressbar-label'></span></div><div class='btngrp submit' id='[[prefix]]submit'><a id='[[prefix]]submit'>submit</a></div>",modal:"<div class='[[module]]modal' id='[[prefix]]modal'><div class='[[module]]modal-inner' id='[[prefix]]modal-inner'></div></div>"},dispatchTable:{reset:"reset",prev:"prev",next:"next",closebtn:"closeview",submit:"submitForm"},render:function(){var e="",t;for(t in this.elems){var n=/select/i.test(this.elems[t].tagName)?"select":/textarea/i.test(this.elems[t].tagName)?"textarea":this.elems[t].type;e+=this.templates.element({type:n,name:t,displayName:a.camelToSentance(t)})}var r=document.createElement("div"),i=document.createElement("div");r.id="outer-container",r.innerHTML=this.templates.container({inner:this.templates.list({inner:e}),controls:this.templates.controls()}),i.innerHTML=this.templates.modal(),this.append(r),this.append(i);var s=0;for(t in this.elems)this.rendered[s]=this.rendered[t]=this.getById(t),this.rendered[s].setAttribute("state",p.STATES.INCOMPLETE),s++},dispatch:function(e){var t=this.getElName(e.id);return t&&(this[this.dispatchTable[t]]||S.noop).call(this,e),t||e.getAttribute("name")||e.getAttribute("value")},select:function(e){var t=e.name||e.getAttribute("name");if(!e)return console.log("Warning: attempting trying to select invalid element");S(this.current.el).removeClass(this.ACTIVE_CLASS,this.current.el),this.current.el=e,this.current.name=t,this.current.index=this.elemIndexes[t],S(e).addClass(this.ACTIVE_CLASS,e)},changeListener:function(e){if(a.toString.call(e)==="[object CustomEvent]"&&e.detail){var t=e.detail,n=this.rendered[t.name],r=n.getAttribute("state");r&&r!==t.state&&(r!==p.STATES.INCOMPLETE||t.state===p.STATES.VALID)&&(t.state===p.STATES.INVALID?this.completed(-1):t.state===p.STATES.INCOMPLETE&&r===p.STATES.VALID?this.completed(-1):t.state===p.STATES.VALID&&this.completed(1)),n.setAttribute("valid",t.valid),n.setAttribute("state",t.state)}},focusListener:function(e){var t=e.target.name,n;(n=this.rendered[t])&&this.select(n)},clickListener:function(e){var t=this.dispatch(e.target);console.log(t),t&&this.elems[t]&&this.elems[t].focus()},submitListener:function(e){this.stats.completed||(e.preventDefault(),e.stopPropagation())},completed:function(e){this.stats.complete+=e,console.log(this.stats.complete),this.stats.complete===this.stats.total?(console.log("done"),this.stats.completed=!0,this.submitButton.removeAttribute("disabled")):(this.stats.completed=!1,this.submitButton.setAttribute("disabled",!0)),this.dom("progress-inner").style.width=this.stats.complete/this.stats.total*100+"%",this.dom("progressbar-label").innerHTML=this.stats.complete+"/"+this.stats.total+" complete"},reset:function(e,t){this.form.reset(),this.elemsArray[0].focus(),this.stats.complete=0,this.stats.completed=!1,this.fire("form-reset",{form:this.form})},move:function(e){var t=this.current.index+e;if(t>=0&&t<this.elemsArray.length){var n=this.elemsArray[t];return n.focus(e),this.select(this.rendered[n.getAttribute("name")]),n}},prev:function(e,t){this.move(-1)},next:function(e,t){this.move(1)},closeview:function(e){var t;(t=e.getAttribute("oldheight"))?(this.dom("inner").style.height=t,e.innerHTML="hide",e.removeAttribute("oldheight")):(e.setAttribute("oldheight",this.dom("inner").style.height||this.dom("inner").offsetHeight+"px"),e.innerHTML="show",this.dom("inner").style.height="35px")},submitForm:function(e,t){this.form.submit()}});var p={SELECT_CLASS:"formal-selected",ACTIVE_CLASS:"formal-active",HIDDEN_CLASS:"formal-hidden-support",INPUT_ELS:/input|select|textarea/i,CHANGE_EVT:"input-change",SELECTABLE_ELEM:"a",VALUE_DELIM:",",PREFIX_DELIM:"___",LEFT_KEY:37,RIGHT_KEY:39,ENTER_KEY:13,LEFT:-1,RIGHT:1,STATES:{INCOMPLETE:"incomplete",VALID:"valid",INVALID:"invalid"}};v.prototype={cnst:{ATTR:"type",TAG:"div"},wrappers:{checkbox:w,radio:E,_:y},check:function(e,t){return e&&!this.wrapped[t]&&e.tagName===this.cnst.TAG&&e.hasAttribute(this.cnst.ATTR)},wrap:function(e){var t=e.innerHTML,n=/checkbox/i.test(t)?"checkbox":/radio/i.test(t)?"radio":"_";return this.wrappers[this.wrappers.length]=new this.wrappers[n](e)}},a.inherits(c,m),S.extend(m.prototype,{val:function(e){return e!==n&&(this.input.value=e),this.input.value},fireEvent:function(e,t){return this.el.dispatchEvent(a.customEvent(e,S.extend(new g(this.isValid(),this.fieldState(),this.input.value,this.name),t)))},moveout:function(e){},cnst:{SELECT_CLASS:p.SELECT_CLASS,ACTIVE_CLASS:p.ACTIVE_CLASS,SELECTABLE_ELEM:p.SELECTABLE_ELEM,VALUE_DELIM:p.VALUE_DELIM},isValid:function(){return this.validation(this.input.value)},fieldState:function(){var e="",t=this.input;return console.log(t),!t.value||!t.value.length?e=p.STATES.INCOMPLETE:t.validity?e=t.validity.valid?p.STATES.VALID:p.STATES.INVALID:e=p.STATES.INVALID,e},keyEvent:function(e,t){e.preventDefault(),e.stopPropagation()}}),g.valid=function(e){return!(e&&e.valid===n||e.state===n||e.value===n||e.name===n)},a.inherits(m,y),y.prototype.onfocus=function(e,t){t=t||e.direction;var n=this.input.value.length;t===p.LEFT?this.input.setSelectionRange(n,n):this.input.setSelectionRange(0,0)},a.inherits(m,b),b.prototype.onfocus=function(e,t){this.activate(0)},b.prototype.templates={item:'<a class="[[module]]item" id="[[prefix]][[value]]" name="[[name]]" value="[[value]]">[[displayValue]]</a>',group:"<div class='[[module]]group' id='[[prefix]][[name]]' name='[[name]]'>[[inner]]</div>"},b.prototype.keyEvent=function(e,t){var n=t===p.LEFT_KEY?p.LEFT:t===p.RIGHT_KEY?p.RIGHT:null;if(!!n){var r=n+this.active;if(r<0||r>this.count)return;this.activate(r),e.preventDefault(),e.stopPropagation();return}t===p.ENTER_KEY&&(this.select(this.active),e.preventDefault(),e.stopPropagation())},b.prototype.activate=function(e){S(this.elements[this.active]).removeClass(p.ACTIVE_CLASS),S(this.elements[this.active=e]).addClass(p.ACTIVE_CLASS)},b.prototype.onselection=function(e,t,n){this.selection=this.selection||[];if(!n)this.selection.push(e);else{var r=0,i=this.selection.length;for(;r<i;r++)this.selection[r]===e&&(this.selection[r]=null)}console.log(this.updateValue())},b.prototype.updateValue=function(){var e=0,t=this.selection.length,n=[];for(;e<t;e++)this.selection[e]&&this.selection[e].hasAttribute("value")&&n.push(this.selection[e].getAttribute("value"));return this.fireEvent(p.CHANGE_EVT,{}),this.input.value=n.join(p.VALUE_DELIM)},b.prototype.select=function(e){e=typeof e=="object"?e.value||e.getAttribute("value"):e;var t=this.elements[e],n=S(t),r=n.hasClass(p.SELECT_CLASS),i;n.toggleClass(p.SELECT_CLASS),this.onselection(t,n,r)},a.inherits(b,w),a.inherits(b,E),E.prototype.onselection=function(e,t,n){S(this.selection[0]).removeClass(p.SELECT_CLASS),n?this.selection=[]:this.selection=[e],this.updateValue()};var S=t.jq_shim;T.prototype={current:function(e){return e&&p.INPUT_ELS.test(e.tagName)&&(this.timeline.select(e),e.focus()),this.timeline.current.el},next:function(){return this.timeline.next()},prev:function(){return this.timeline.next()},isComplete:function(){return this.timeline.stats.completed},complete:function(e){var t=this;return(e||"~d%").replace(/~d/,function(e,n){return t.timeline.stats.complete/t.timeline.stats.total})}},t.Formal=T,S.isShim||(S.fn.Formal=function(e){var t=this.get(0);return/form/i.test(t.tagName)||(t=this.find("form").get(0)),this.Formal=new T(t,e),this})})(window);